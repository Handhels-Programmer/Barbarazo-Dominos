<!DOCTYPE html>
<html lang="do">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DominoManager Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Iconos Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Fuente Google -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Scrollbar personalizado */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        /* Ocultar flechas de input number */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen pb-20">

    <!-- NAVBAR -->
    <header class="bg-slate-800 border-b border-slate-700 sticky top-0 z-30 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-emerald-600 p-2 rounded-lg shadow-lg shadow-emerald-900/50">
                    <i data-lucide="layout-grid" class="text-white w-5 h-5"></i>
                </div>
                <h1 class="text-xl font-bold hidden sm:block">DominoManager <span class="text-emerald-500">Pro</span></h1>
            </div>

            <div class="flex items-center gap-3">
                <!-- Estado Conexión -->
                <div id="connection-status" class="h-2 w-2 rounded-full bg-red-500 animate-pulse" title="Desconectado"></div>

                <!-- Controles de Usuario -->
                <div id="admin-controls" class="hidden flex items-center gap-2 bg-slate-700/50 rounded-lg p-1 border border-emerald-500/30">
                    <span class="px-3 py-1 bg-emerald-600 text-white rounded text-xs font-bold shadow">ADMIN</span>
                    <button onclick="window.app.logoutAdmin()" class="p-1 text-slate-400 hover:text-red-400" title="Salir">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                    </button>
                </div>

                <button id="btn-login" onclick="window.app.showLoginModal()" class="flex items-center gap-2 px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700 text-slate-300 text-sm font-medium transition-all">
                    <i data-lucide="lock" class="w-4 h-4"></i>
                    <span class="hidden xs:inline">Acceso Admin</span>
                </button>

                <button onclick="window.app.toggleHistory()" class="p-2 rounded-lg text-slate-400 hover:bg-slate-700 transition-colors border border-transparent" id="btn-history">
                    <i data-lucide="history" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4">
        
        <!-- DASHBOARD (Solo Admin) -->
        <div id="dashboard-stats" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8 fade-in">
            <!-- Inyectado por JS -->
        </div>

        <!-- BARRA DE ACCIÓN (Crear Mesa) -->
        <div id="action-bar" class="hidden mb-6 flex gap-2 fade-in">
            <input type="text" id="new-table-name" placeholder="Nombre nueva mesa..." 
                class="bg-slate-800 border-slate-700 border rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-emerald-500 focus:outline-none w-full sm:w-auto placeholder-slate-500">
            <button onclick="window.app.addTable()" class="bg-slate-800 hover:bg-slate-700 text-emerald-400 border border-slate-700 px-4 py-2 rounded-lg flex items-center gap-2 transition-colors whitespace-nowrap font-medium">
                <i data-lucide="plus" class="w-5 h-5"></i> <span class="hidden sm:inline">Añadir Mesa</span>
            </button>
        </div>

        <!-- VISTA HISTORIAL -->
        <div id="history-view" class="hidden bg-slate-800 rounded-xl border border-slate-700 overflow-hidden mb-8 shadow-xl fade-in">
            <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900/50">
                <h2 class="font-bold text-lg flex items-center gap-2 text-emerald-400">
                    <i data-lucide="history" class="w-5 h-5"></i> Historial de Cierres
                </h2>
                <button onclick="window.app.toggleHistory()" class="text-slate-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="overflow-x-auto max-h-[60vh]">
                <table class="w-full text-left text-sm text-slate-400">
                    <thead class="bg-slate-900/80 text-slate-200 uppercase font-medium sticky top-0 backdrop-blur-sm">
                        <tr>
                            <th class="px-4 py-3">Mesa</th>
                            <th class="px-4 py-3">Fecha/Hora</th>
                            <th class="px-4 py-3">Jugadores</th>
                            <th class="px-4 py-3 text-right">Total Cobrado</th>
                        </tr>
                    </thead>
                    <tbody id="history-list">
                        <!-- Inyectado por JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- GRID DE MESAS -->
        <div id="tables-grid" class="grid gap-6 md:grid-cols-2 xl:grid-cols-3 fade-in">
            <!-- Mesas inyectadas por JS -->
        </div>

        <div id="empty-state" class="hidden col-span-full py-12 text-center text-slate-600 border-2 border-dashed border-slate-800 rounded-xl mt-8">
            <i data-lucide="layout-grid" class="mx-auto mb-3 opacity-20 w-12 h-12"></i>
            <p class="text-lg">No hay mesas activas.</p>
        </div>

    </main>

    <!-- MODAL LOGIN ADMIN -->
    <div id="login-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 fade-in">
        <div class="bg-slate-800 rounded-2xl border border-slate-700 shadow-2xl p-6 w-full max-w-sm relative">
            <button onclick="window.app.closeLoginModal()" class="absolute right-4 top-4 text-slate-500 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            
            <div class="flex items-center gap-2 mb-6 text-xl font-bold text-white">
                <i data-lucide="lock" class="text-emerald-500"></i> Admin Login
            </div>
            
            <form onsubmit="event.preventDefault(); window.app.loginAdmin();" class="space-y-4">
                <div>
                    <label class="block text-xs uppercase tracking-wider text-slate-500 mb-2">Contraseña</label>
                    <input type="password" id="admin-password" autofocus
                        class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-emerald-500 outline-none placeholder-slate-600"
                        placeholder="••••••••">
                    <p id="login-error" class="text-red-400 text-xs mt-2 hidden flex items-center gap-1">
                        <i data-lucide="alert-circle" class="w-3 h-3"></i> Contraseña incorrecta
                    </p>
                </div>
                <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-lg transition-colors shadow-lg shadow-emerald-900/20">
                    Entrar
                </button>
                <div class="text-center">
                    <p class="text-[10px] text-slate-600">Contraseña demo: <span class="font-mono text-slate-500">admin123</span></p>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL AGREGAR DEUDA (NUEVO) -->
    <div id="debt-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 fade-in">
        <div class="bg-slate-800 rounded-2xl border border-slate-700 shadow-2xl p-6 w-full max-w-sm relative border-t-4 border-t-red-500">
            <button onclick="window.app.closeDebtModal()" class="absolute right-4 top-4 text-slate-500 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            
            <div class="flex items-center gap-2 mb-4 text-xl font-bold text-white">
                <i data-lucide="trending-up" class="text-red-400"></i> Agregar Deuda/Pérdida
            </div>
            
            <div class="text-sm text-slate-400 mb-4" id="debt-player-name">Jugador</div>

            <form onsubmit="event.preventDefault(); window.app.confirmDebt();" class="space-y-4">
                <div>
                    <label class="block text-xs uppercase tracking-wider text-slate-500 mb-2">Monto a agregar ($)</label>
                    <input type="number" id="debt-amount"
                        class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white text-lg font-mono focus:ring-2 focus:ring-red-500 outline-none placeholder-slate-600"
                        placeholder="0">
                </div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="window.app.closeDebtModal()" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 rounded-lg transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 bg-red-600 hover:bg-red-500 text-white font-bold py-3 rounded-lg transition-colors shadow-lg shadow-red-900/20">
                        Confirmar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script type="module">
        // Importar Firebase desde CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Configuración (Inyectada por el entorno)
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Estado Global
        let state = {
            user: null,
            isAdmin: false,
            tables: [],
            history: [],
            showHistory: false,
            tempAction: null // Almacena { tableId, playerIndex } para el modal
        };

        // --- Funciones Principales ---
        const App = {
            
            // --- Autenticación Admin ---
            showLoginModal: () => {
                document.getElementById('login-modal').classList.remove('hidden');
                setTimeout(() => document.getElementById('admin-password').focus(), 100);
            },
            
            closeLoginModal: () => {
                document.getElementById('login-modal').classList.add('hidden');
                document.getElementById('login-error').classList.add('hidden');
                document.getElementById('admin-password').value = '';
            },

            loginAdmin: () => {
                const pass = document.getElementById('admin-password').value;
                if (pass === 'admin123') {
                    state.isAdmin = true;
                    App.closeLoginModal();
                    renderUI();
                } else {
                    document.getElementById('login-error').classList.remove('hidden');
                }
            },

            logoutAdmin: () => {
                state.isAdmin = false;
                renderUI();
            },

            toggleHistory: () => {
                state.showHistory = !state.showHistory;
                renderUI();
            },

            // --- Gestión de Deuda con Modal (NUEVO) ---
            openDebtModal: (tableId, playerIndex) => {
                const table = state.tables.find(t => t.id === tableId);
                if (!table) return;
                const player = table.players[playerIndex];

                state.tempAction = { tableId, playerIndex };
                
                // Actualizar UI del modal
                document.getElementById('debt-player-name').innerText = `Agregando deuda a: ${player.name || 'Jugador ' + (playerIndex + 1)}`;
                document.getElementById('debt-amount').value = '';
                
                document.getElementById('debt-modal').classList.remove('hidden');
                setTimeout(() => document.getElementById('debt-amount').focus(), 100);
            },

            closeDebtModal: () => {
                document.getElementById('debt-modal').classList.add('hidden');
                state.tempAction = null;
            },

            confirmDebt: async () => {
                if (!state.tempAction) return;
                
                const amountInput = document.getElementById('debt-amount');
                const amount = parseInt(amountInput.value);
                
                if (isNaN(amount) || amount <= 0) {
                    alert("Por favor ingrese un monto válido mayor a 0.");
                    amountInput.focus();
                    return;
                }

                const { tableId, playerIndex } = state.tempAction;
                const table = state.tables.find(t => t.id === tableId);
                if (table) {
                    const newPlayers = [...table.players];
                    newPlayers[playerIndex].debt = (newPlayers[playerIndex].debt || 0) + amount;
                    
                    // Cerrar modal primero para mejor UX
                    App.closeDebtModal();
                    
                    try {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tables', tableId), { players: newPlayers });
                    } catch (err) {
                        console.error("Error updating debt:", err);
                        alert("Error al guardar. Verifique su conexión.");
                    }
                }
            },

            // --- Otras Acciones ---
            addTable: async () => {
                if (!state.user) return;
                const input = document.getElementById('new-table-name');
                const name = input.value.trim() || `Mesa ${state.tables.length + 1}`;
                
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'tables'), {
                        name: name,
                        status: 'available',
                        players: Array(4).fill(null).map((_, i) => ({ id: `new_${i}`, name: "", debt: 0, paid: 0 })),
                        startTime: null,
                        createdAt: Date.now()
                    });
                    input.value = '';
                } catch (e) { console.error(e); }
            },

            updatePlayerName: async (tableId, playerIndex, newName) => {
                const table = state.tables.find(t => t.id === tableId);
                if (!table) return;

                const newPlayers = [...table.players];
                newPlayers[playerIndex].name = newName;
                
                let updates = { players: newPlayers };
                if (newName !== "" && table.status === 'available') {
                    updates.status = 'playing';
                    updates.startTime = new Date().toLocaleTimeString();
                }

                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tables', tableId), updates);
            },

            payDebt: async (tableId, playerIndex) => {
                const table = state.tables.find(t => t.id === tableId);
                const newPlayers = [...table.players];
                const debt = newPlayers[playerIndex].debt || 0;
                
                if (debt > 0 && confirm(`¿Marcar $${debt} como PAGADO?`)) {
                    newPlayers[playerIndex].paid = (newPlayers[playerIndex].paid || 0) + debt;
                    newPlayers[playerIndex].debt = 0;
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tables', tableId), { players: newPlayers });
                }
            },

            closeTable: async (tableId) => {
                const table = state.tables.find(t => t.id === tableId);
                if (confirm("¿Cerrar mesa y archivar sesión?")) {
                    const totalPaid = table.players.reduce((acc, p) => acc + (p.paid || 0), 0);
                    
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'history'), {
                        ...table,
                        completedAt: new Date().toLocaleTimeString(),
                        date: new Date().toLocaleDateString(),
                        closedAtTimestamp: Date.now(),
                        totalPaid
                    });
                    
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tables', tableId), {
                        status: 'available',
                        players: Array(4).fill(null).map((_, i) => ({ id: `reset_${i}`, name: "", debt: 0, paid: 0 })),
                        startTime: null
                    });
                }
            },

            deleteTable: async (tableId) => {
                if (confirm("¿Eliminar esta mesa permanentemente?")) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tables', tableId));
                }
            }
        };

        window.app = App;

        // --- Inicialización ---
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };
        initAuth();

        onAuthStateChanged(auth, (user) => {
            state.user = user;
            const statusEl = document.getElementById('connection-status');
            if (user) {
                statusEl.classList.replace('bg-red-500', 'bg-emerald-500');
                initDataListeners();
            } else {
                statusEl.classList.replace('bg-emerald-500', 'bg-red-500');
            }
        });

        function initDataListeners() {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'tables'), (snapshot) => {
                state.tables = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                    .sort((a, b) => a.createdAt - b.createdAt);
                renderUI();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'history'), (snapshot) => {
                state.history = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                    .sort((a, b) => b.closedAtTimestamp - a.closedAtTimestamp);
                renderUI();
            });
        }

        // --- Renderizado (Vista) ---
        function renderUI() {
            const { isAdmin, showHistory, tables, history } = state;
            
            document.getElementById('admin-controls').classList.toggle('hidden', !isAdmin);
            document.getElementById('btn-login').classList.toggle('hidden', isAdmin);
            document.getElementById('action-bar').classList.toggle('hidden', !isAdmin || showHistory);
            document.getElementById('dashboard-stats').classList.toggle('hidden', !isAdmin);
            document.getElementById('history-view').classList.toggle('hidden', !showHistory);
            document.getElementById('tables-grid').classList.toggle('hidden', showHistory);
            document.getElementById('empty-state').classList.toggle('hidden', showHistory || tables.length > 0);

            if (isAdmin) renderStats();
            if (!showHistory) renderTables();
            if (showHistory) renderHistory();

            lucide.createIcons();
        }

        function renderStats() {
            const today = new Date().toLocaleDateString();
            let totalDebt = 0;
            let totalCollected = 0;
            let activeCount = 0;
            let loser = { name: 'Nadie', amount: 0 };

            state.tables.forEach(t => {
                if (t.status === 'playing') activeCount++;
                t.players.forEach(p => {
                    totalDebt += (p.debt || 0);
                    totalCollected += (p.paid || 0);
                    if ((p.debt || 0) > loser.amount) loser = { name: p.name, amount: p.debt };
                });
            });

            state.history.forEach(h => {
                if (h.date === today) totalCollected += (h.totalPaid || 0);
            });

            const statsHTML = `
                ${createStatCard('dollar-sign', 'Ingresos Hoy', `$${totalCollected}`, 'emerald')}
                ${createStatCard('alert-circle', 'Por Cobrar', `$${totalDebt}`, 'red')}
                ${createStatCard('activity', 'Activas', activeCount, 'blue')}
                ${createStatCard('trending-up', 'Mayor Deudor', loser.amount > 0 ? `$${loser.amount}` : '-', 'orange', loser.name)}
            `;
            document.getElementById('dashboard-stats').innerHTML = statsHTML;
        }

        function createStatCard(icon, label, value, color, subtext = '') {
            return `
            <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 relative overflow-hidden">
                <div class="absolute right-0 top-0 p-3 opacity-10 text-${color}-500">
                    <i data-lucide="${icon}" width="48" height="48"></i>
                </div>
                <div class="flex items-center gap-3 mb-2">
                    <div class="p-2 rounded-lg bg-${color}-500/10 text-${color}-400">
                        <i data-lucide="${icon}" class="w-5 h-5"></i>
                    </div>
                    <span class="text-slate-400 text-sm font-medium">${label}</span>
                </div>
                <div class="text-2xl font-bold text-white mb-1">${value}</div>
                ${subtext ? `<div class="text-xs text-slate-500">${subtext}</div>` : ''}
            </div>`;
        }

        function renderTables() {
            const container = document.getElementById('tables-grid');
            container.innerHTML = state.tables.map(table => {
                const isPlaying = table.status === 'playing';
                const totalDebt = table.players.reduce((acc, p) => acc + (p.debt || 0), 0);
                const playerCount = table.players.filter(p => p.name).length;

                return `
                <div class="rounded-xl border shadow-xl transition-all ${isPlaying ? 'bg-slate-800 border-emerald-500/30 shadow-emerald-900/10' : 'bg-slate-800/60 border-slate-700 border-dashed'}">
                    <div class="p-4 border-b border-slate-700/50 flex justify-between items-start">
                        <div>
                            <h3 class="font-bold text-lg flex items-center gap-2 ${isPlaying ? 'text-emerald-400' : 'text-slate-500'}">
                                ${table.name}
                                <span class="text-[10px] px-2 py-0.5 rounded-full border ${isPlaying ? 'bg-emerald-500/10 border-emerald-500/20 text-emerald-400' : 'bg-slate-700 border-slate-600 text-slate-400'}">
                                    ${isPlaying ? 'EN JUEGO' : 'DISPONIBLE'}
                                </span>
                            </h3>
                            <div class="text-xs text-slate-500 mt-1 flex items-center gap-2">
                                <i data-lucide="users" class="w-3 h-3"></i> ${playerCount}/4
                            </div>
                        </div>
                        ${state.isAdmin ? `
                        <div class="flex gap-1">
                            ${isPlaying ? `<button onclick="window.app.closeTable('${table.id}')" class="p-2 text-slate-400 hover:text-emerald-400 hover:bg-emerald-400/10 rounded-lg"><i data-lucide="save" class="w-4 h-4"></i></button>` : ''}
                            <button onclick="window.app.deleteTable('${table.id}')" class="p-2 text-slate-600 hover:text-red-400 hover:bg-red-400/10 rounded-lg"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                        ` : ''}
                    </div>

                    <div class="p-4 space-y-2">
                        ${table.players.map((p, idx) => renderPlayerRow(table.id, idx, p, state.isAdmin)).join('')}
                    </div>

                    <div class="px-4 py-3 bg-slate-900/50 border-t border-slate-700/50 rounded-b-xl flex justify-between items-center">
                        <span class="text-xs text-slate-500">Total Adeudado</span>
                        <span class="font-mono font-bold text-lg ${totalDebt > 0 ? 'text-red-400' : 'text-slate-600'}">$${totalDebt}</span>
                    </div>
                </div>
                `;
            }).join('');
        }

        function renderPlayerRow(tableId, idx, p, isAdmin) {
            const hasName = p.name && p.name !== "";
            const debt = p.debt || 0;
            
            return `
            <div class="flex items-center justify-between bg-slate-900/40 p-2 rounded-lg group hover:bg-slate-900/60 transition-colors">
                <div class="flex items-center gap-3 flex-1 overflow-hidden">
                    <div class="p-1.5 rounded-full flex-shrink-0 ${hasName ? 'bg-slate-700 text-slate-300' : 'bg-slate-800 text-slate-600'}">
                        <i data-lucide="user-circle" class="w-5 h-5"></i>
                    </div>
                    ${isAdmin ? 
                        `<input class="bg-transparent text-sm text-slate-200 placeholder-slate-600 focus:outline-none w-full"
                           placeholder="Jugador ${idx + 1}" value="${p.name}" 
                           onchange="window.app.updatePlayerName('${tableId}', ${idx}, this.value)">` 
                        : 
                        `<span class="text-sm truncate ${hasName ? 'text-slate-200' : 'text-slate-600 italic'}">${p.name || "Vacío"}</span>`
                    }
                </div>
                
                ${hasName ? `
                <div class="flex items-center gap-3 pl-2">
                    <div class="text-right flex-shrink-0">
                        <div class="text-sm font-mono font-bold ${debt > 0 ? 'text-red-400' : 'text-emerald-500'}">$${debt}</div>
                        ${isAdmin ? `<div class="text-[10px] text-slate-500">Pagado: $${p.paid || 0}</div>` : ''}
                    </div>
                    ${isAdmin ? `
                    <div class="flex gap-1">
                        <button onclick="window.app.openDebtModal('${tableId}', ${idx})" title="Añadir deuda" class="p-1.5 text-slate-500 hover:text-red-400 hover:bg-slate-800 rounded">
                            <i data-lucide="trending-up" class="w-4 h-4"></i>
                        </button>
                        ${debt > 0 ? `
                        <button onclick="window.app.payDebt('${tableId}', ${idx})" title="Pagar" class="p-1.5 text-slate-500 hover:text-emerald-400 hover:bg-emerald-400/10 rounded">
                            <i data-lucide="wallet" class="w-4 h-4"></i>
                        </button>` : ''}
                    </div>
                    ` : ''}
                </div>
                ` : ''}
            </div>
            `;
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            if (state.history.length === 0) {
                list.innerHTML = `<tr><td colspan="4" class="px-4 py-8 text-center italic text-slate-600">No hay registros aún</td></tr>`;
                return;
            }
            list.innerHTML = state.history.map(h => `
                <tr class="border-b border-slate-700/50 hover:bg-slate-700/30">
                    <td class="px-4 py-3 font-medium text-white">${h.name}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-xs text-slate-400">${h.date}<br>${h.completedAt}</td>
                    <td class="px-4 py-3 max-w-xs truncate text-slate-300">
                        ${h.players ? h.players.filter(p => p.name).map(p => p.name).join(", ") : "Sin datos"}
                    </td>
                    <td class="px-4 py-3 text-right text-emerald-400 font-mono font-bold">$${h.totalPaid || 0}</td>
                </tr>
            `).join('');
        }

    </script>
</body>

</html>
