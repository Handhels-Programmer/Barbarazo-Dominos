<!DOCTYPE html>
<html lang="do">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barbarazo Domino</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Iconos Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Fuente Google -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Russo+One&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        h1, .brand-font { font-family: 'Russo One', sans-serif; letter-spacing: 0.05em; }
        
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Scrollbar personalizado - Tono Ámbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1c1917; }
        ::-webkit-scrollbar-thumb { background: #78350f; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #b45309; }
        
        /* Ocultar flechas de input number */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
    </style>
</head>
<body class="bg-stone-950 text-stone-100 min-h-screen pb-20 selection:bg-amber-500 selection:text-black">

    <!-- NAVBAR -->
    <header class="bg-stone-900 border-b border-amber-900/30 sticky top-0 z-30 shadow-lg shadow-black/50">
        <div class="max-w-7xl mx-auto px-4 h-20 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <!-- LOGO CONTAINER -->
                <div class="relative group">
                    <div class="absolute -inset-1 bg-gradient-to-r from-amber-600 to-orange-600 rounded-lg blur opacity-25 group-hover:opacity-75 transition duration-1000 group-hover:duration-200"></div>
                    <div class="relative bg-stone-900 p-1 rounded-lg border border-amber-800">
                        <img src="Logo.jpg" alt="Logo" class="h-12 w-12 rounded object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <i data-lucide="beer" class="text-amber-500 w-10 h-10 hidden"></i>
                    </div>
                </div>
                
                <div class="flex flex-col">
                    <h1 class="text-2xl font-bold hidden sm:block text-white uppercase" style="text-shadow: 2px 2px 0px #78350f;">
                        Barbarazo
                    </h1>
                    <span class="text-xs text-amber-500 font-medium tracking-widest hidden sm:block">DOMINO CLUB</span>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <!-- Estado Conexión (MEJORADO) -->
                <div class="flex items-center gap-2 bg-stone-950/50 px-3 py-1.5 rounded-full border border-stone-800">
                    <div id="connection-status" class="h-2.5 w-2.5 rounded-full bg-red-600 shadow-[0_0_10px_rgba(220,38,38,0.5)] transition-colors duration-500"></div>
                    <span id="connection-text" class="text-[10px] uppercase font-bold text-stone-500 tracking-wider">Desconectado</span>
                </div>

                <!-- Controles de Usuario -->
                <div id="admin-controls" class="hidden flex items-center gap-2 bg-stone-800 rounded-lg p-1 border border-amber-500/30 shadow-inner">
                    <span class="px-3 py-1 bg-amber-600 text-stone-900 rounded text-xs font-bold shadow brand-font">ADMIN</span>
                    <button onclick="window.app.logoutAdmin()" class="p-1 text-stone-400 hover:text-red-400 transition-colors" title="Salir">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                    </button>
                </div>

                <button id="btn-login" onclick="window.app.showLoginModal()" class="flex items-center gap-2 px-3 py-2 rounded-lg bg-stone-800 hover:bg-stone-700 border border-stone-700 text-amber-500/80 hover:text-amber-400 text-sm font-medium transition-all hover:border-amber-500/50">
                    <i data-lucide="lock" class="w-4 h-4"></i>
                    <span class="hidden xs:inline">Admin</span>
                </button>

                <button onclick="window.app.toggleHistory()" class="p-2 rounded-lg text-stone-400 hover:text-amber-400 hover:bg-stone-800 transition-colors border border-transparent hover:border-stone-700" id="btn-history">
                    <i data-lucide="history" class="w-6 h-6"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 pt-8">
        
        <!-- DASHBOARD (Solo Admin) -->
        <div id="dashboard-stats" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8 fade-in">
            <!-- Inyectado por JS -->
        </div>

        <!-- BARRA DE ACCIÓN (Crear Mesa) -->
        <div id="action-bar" class="hidden mb-8 flex gap-3 fade-in bg-stone-900 p-4 rounded-xl border border-stone-800 shadow-xl">
            <input type="text" id="new-table-name" placeholder="Nombre de la nueva mesa..." 
                class="bg-stone-950 border-stone-700 border rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-amber-500 focus:border-amber-500 focus:outline-none w-full placeholder-stone-600">
            <button onclick="window.app.addTable()" class="bg-amber-600 hover:bg-amber-500 text-stone-950 border border-amber-500 px-6 py-2 rounded-lg flex items-center gap-2 transition-all font-bold shadow-[0_4px_0_rgb(120,53,15)] active:shadow-none active:translate-y-[4px] whitespace-nowrap">
                <i data-lucide="plus" class="w-5 h-5"></i> <span class="hidden sm:inline">Nueva Mesa</span>
            </button>
        </div>

        <!-- VISTA HISTORIAL -->
        <div id="history-view" class="hidden bg-stone-900 rounded-xl border border-amber-900/30 overflow-hidden mb-8 shadow-2xl fade-in">
            <div class="p-4 border-b border-stone-800 flex justify-between items-center bg-stone-950/50">
                <h2 class="font-bold text-lg flex items-center gap-2 text-amber-500 brand-font">
                    <i data-lucide="scroll" class="w-5 h-5"></i> Historial de Partidas
                </h2>
                <button onclick="window.app.toggleHistory()" class="text-stone-500 hover:text-white transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="overflow-x-auto max-h-[60vh]">
                <table class="w-full text-left text-sm text-stone-400">
                    <thead class="bg-stone-950 text-stone-300 uppercase font-medium sticky top-0 border-b border-stone-800">
                        <tr>
                            <th class="px-6 py-4">Mesa</th>
                            <th class="px-6 py-4">Fecha/Hora</th>
                            <th class="px-6 py-4">Jugadores</th>
                            <th class="px-6 py-4 text-right">Total</th>
                        </tr>
                    </thead>
                    <tbody id="history-list">
                        <!-- Inyectado por JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- GRID DE MESAS -->
        <div id="tables-grid" class="grid gap-6 md:grid-cols-2 xl:grid-cols-3 fade-in pb-10">
            <!-- Mesas inyectadas por JS -->
        </div>

        <div id="empty-state" class="hidden col-span-full py-20 text-center text-stone-600 border-2 border-dashed border-stone-800 rounded-xl mt-8 bg-stone-900/30">
            <div class="bg-stone-800 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="layout-grid" class="opacity-20 w-10 h-10 text-stone-400"></i>
            </div>
            <p class="text-xl font-medium text-stone-500">No hay mesas activas</p>
            <p class="text-sm mt-2 text-stone-600">¡Abre una mesa para comenzar el juego!</p>
        </div>

    </main>

    <!-- MODAL LOGIN ADMIN -->
    <div id="login-modal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm z-50 flex items-center justify-center p-4 fade-in">
        <div class="bg-stone-900 rounded-2xl border border-amber-600/30 shadow-2xl p-8 w-full max-w-sm relative">
            <button onclick="window.app.closeLoginModal()" class="absolute right-4 top-4 text-stone-500 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            
            <div class="flex items-center justify-center gap-3 mb-8">
                <div class="bg-amber-500/10 p-3 rounded-full border border-amber-500/20">
                    <i data-lucide="lock" class="text-amber-500 w-8 h-8"></i>
                </div>
            </div>
            
            <h3 class="text-2xl font-bold text-center text-white brand-font mb-6">Acceso Admin</h3>
            
            <form onsubmit="event.preventDefault(); window.app.loginAdmin();" class="space-y-6">
                <div>
                    <input type="password" id="admin-password" autofocus
                        class="w-full bg-stone-950 border border-stone-700 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-amber-500 outline-none placeholder-stone-600 text-center text-lg tracking-widest"
                        placeholder="••••••••">
                    <p id="login-error" class="text-red-500 text-xs mt-3 hidden flex items-center justify-center gap-1 font-medium bg-red-500/10 py-1 rounded">
                        <i data-lucide="alert-circle" class="w-3 h-3"></i> Contraseña incorrecta
                    </p>
                </div>
                <button type="submit" class="w-full bg-amber-600 hover:bg-amber-500 text-stone-950 font-bold py-3 rounded-lg transition-colors shadow-lg shadow-amber-900/20 uppercase tracking-wide">
                    Entrar
                </button>
            </form>
        </div>
    </div>

    <!-- MODAL AGREGAR DEUDA -->
    <div id="debt-modal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm z-50 flex items-center justify-center p-4 fade-in">
        <div class="bg-stone-900 rounded-2xl border border-stone-800 shadow-2xl p-6 w-full max-w-sm relative border-t-4 border-t-red-600">
            <button onclick="window.app.closeDebtModal()" class="absolute right-4 top-4 text-stone-500 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            
            <div class="flex items-center gap-2 mb-2 text-xl font-bold text-white brand-font">
                <i data-lucide="trending-up" class="text-red-500"></i> Registrar Pérdida
            </div>
            
            <div class="text-sm text-stone-400 mb-6 font-mono" id="debt-player-name">Jugador</div>

            <form onsubmit="event.preventDefault(); window.app.confirmDebt();" class="space-y-4">
                <div>
                    <label class="block text-xs uppercase tracking-wider text-stone-500 mb-2 font-bold">Monto ($)</label>
                    <div class="relative">
                        <span class="absolute left-4 top-3 text-stone-500">$</span>
                        <input type="number" id="debt-amount"
                            class="w-full bg-stone-950 border border-stone-700 rounded-xl px-4 pl-8 py-4 text-white text-2xl font-mono focus:ring-2 focus:ring-red-500 outline-none placeholder-stone-700"
                            placeholder="0">
                    </div>
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="window.app.closeDebtModal()" class="flex-1 bg-stone-800 hover:bg-stone-700 text-white font-bold py-3 rounded-lg transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 bg-red-600 hover:bg-red-500 text-white font-bold py-3 rounded-lg transition-colors shadow-[0_4px_0_rgb(153,27,27)] active:shadow-none active:translate-y-[4px]">
                        Confirmar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL PAGAR DEUDA -->
    <div id="pay-modal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm z-50 flex items-center justify-center p-4 fade-in">
        <div class="bg-stone-900 rounded-2xl border border-stone-800 shadow-2xl p-6 w-full max-w-sm relative border-t-4 border-t-amber-500">
            <button onclick="window.app.closePayModal()" class="absolute right-4 top-4 text-stone-500 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            
            <div class="flex items-center gap-2 mb-2 text-xl font-bold text-white brand-font">
                <i data-lucide="coins" class="text-amber-500"></i> Registrar Pago
            </div>
            
            <div class="text-sm text-stone-400 mb-6 font-mono" id="pay-player-name">Jugador</div>
            
            <form onsubmit="event.preventDefault(); window.app.confirmPay();" class="space-y-4">
                <div class="bg-stone-950 p-4 rounded-xl border border-stone-800 mb-4 flex justify-between items-center">
                    <span class="text-xs text-stone-500 uppercase font-bold">Deuda Actual</span>
                    <span class="text-red-500 font-mono text-xl font-bold" id="pay-total-debt">$0</span>
                </div>

                <div>
                    <label class="block text-xs uppercase tracking-wider text-stone-500 mb-2 font-bold">Monto a Pagar ($)</label>
                    <div class="relative">
                        <span class="absolute left-4 top-3 text-stone-500">$</span>
                        <input type="number" id="pay-amount"
                            class="w-full bg-stone-950 border border-stone-700 rounded-xl px-4 pl-8 py-4 text-amber-500 text-2xl font-mono focus:ring-2 focus:ring-amber-500 outline-none placeholder-stone-700 font-bold"
                            placeholder="0">
                    </div>
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="window.app.closePayModal()" class="flex-1 bg-stone-800 hover:bg-stone-700 text-white font-bold py-3 rounded-lg transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 bg-amber-600 hover:bg-amber-500 text-stone-950 font-bold py-3 rounded-lg transition-colors shadow-[0_4px_0_rgb(180,83,9)] active:shadow-none active:translate-y-[4px]">
                        Pagar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL CERRAR MESA -->
    <div id="close-modal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm z-50 flex items-center justify-center p-4 fade-in">
        <div class="bg-stone-900 rounded-2xl border border-stone-800 shadow-2xl p-6 w-full max-w-sm relative">
            <button onclick="window.app.closeCloseModal()" class="absolute right-4 top-4 text-stone-500 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            
            <div class="flex flex-col items-center text-center mb-6">
                <div class="bg-amber-500/10 p-4 rounded-full mb-4 border border-amber-500/20">
                    <i data-lucide="save" class="text-amber-500 w-8 h-8"></i>
                </div>
                <h3 class="text-xl font-bold text-white brand-font">Cerrar Mesa</h3>
                <p class="text-stone-400 text-sm mt-2">¿Archivar partida y liberar la mesa?</p>
            </div>
            
            <div class="bg-stone-950/50 p-3 rounded text-xs text-stone-500 text-center mb-6 border border-stone-800">
                Esta acción no se puede deshacer.
            </div>

            <div class="flex gap-3">
                <button onclick="window.app.closeCloseModal()" class="flex-1 bg-stone-800 hover:bg-stone-700 text-white font-bold py-3 rounded-lg transition-colors">
                    Cancelar
                </button>
                <button onclick="window.app.confirmCloseTable()" class="flex-1 bg-amber-600 hover:bg-amber-500 text-stone-950 font-bold py-3 rounded-lg transition-colors shadow-[0_4px_0_rgb(180,83,9)] active:shadow-none active:translate-y-[4px]">
                    Sí, Guardar
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL ELIMINAR MESA -->
    <div id="delete-modal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm z-50 flex items-center justify-center p-4 fade-in">
        <div class="bg-stone-900 rounded-2xl border border-stone-800 shadow-2xl p-6 w-full max-w-sm relative border-t-4 border-t-stone-600">
            <button onclick="window.app.closeDeleteModal()" class="absolute right-4 top-4 text-stone-500 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            
            <div class="flex flex-col items-center text-center mb-6">
                <div class="bg-stone-800 p-4 rounded-full mb-4 border border-stone-700">
                    <i data-lucide="trash-2" class="text-red-500 w-8 h-8"></i>
                </div>
                <h3 class="text-xl font-bold text-white brand-font">Desmantelar Mesa</h3>
                <p class="text-stone-400 text-sm mt-2">¿Eliminar esta mesa permanentemente?</p>
            </div>
            
            <div class="bg-red-500/10 p-3 rounded text-xs text-red-400 text-center mb-6 border border-red-500/20">
                ¡Advertencia! Esto borrará la mesa sin guardar historial.
            </div>

            <div class="flex gap-3">
                <button onclick="window.app.closeDeleteModal()" class="flex-1 bg-stone-800 hover:bg-stone-700 text-white font-bold py-3 rounded-lg transition-colors">
                    Cancelar
                </button>
                <button onclick="window.app.confirmDeleteTable()" class="flex-1 bg-red-600 hover:bg-red-500 text-white font-bold py-3 rounded-lg transition-colors shadow-[0_4px_0_rgb(153,27,27)] active:shadow-none active:translate-y-[4px]">
                    Sí, Borrar
                </button>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script type="module">
        // USAMOS VERSIÓN ESTABLE 10.7.1 PARA TODOS LOS MÓDULOS
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

        // TU CONFIGURACIÓN REAL DE FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDWjJl_DxT4YV4IOcw1EpxyRAlqMswcxg4",
            authDomain: "barbarazo-21337.firebaseapp.com",
            projectId: "barbarazo-21337",
            storageBucket: "barbarazo-21337.firebasestorage.app",
            messagingSenderId: "414416455334",
            appId: "1:414416455334:web:3c6bb0279e68ec38501667",
            measurementId: "G-GEXNC2ET1H"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app); // Añadido analytics aunque no es crítico para el funcionamiento
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Identificador estático para la colección de datos
        const appId = 'barbarazo_data';

        let state = {
            user: null,
            isAdmin: false,
            tables: [],
            history: [],
            showHistory: false,
            tempAction: null 
        };

        const App = {
            
            showLoginModal: () => {
                document.getElementById('login-modal').classList.remove('hidden');
                setTimeout(() => document.getElementById('admin-password').focus(), 100);
            },
            
            closeLoginModal: () => {
                document.getElementById('login-modal').classList.add('hidden');
                document.getElementById('login-error').classList.add('hidden');
                document.getElementById('admin-password').value = '';
            },

            loginAdmin: () => {
                const pass = document.getElementById('admin-password').value;
                if (pass === 'admin123') {
                    state.isAdmin = true;
                    App.closeLoginModal();
                    renderUI();
                } else {
                    document.getElementById('login-error').classList.remove('hidden');
                }
            },

            logoutAdmin: () => {
                state.isAdmin = false;
                renderUI();
            },

            toggleHistory: () => {
                state.showHistory = !state.showHistory;
                renderUI();
            },

            openDebtModal: (tableId, playerIndex) => {
                const table = state.tables.find(t => t.id === tableId);
                if (!table) return;
                const player = table.players[playerIndex];

                state.tempAction = { tableId, playerIndex, type: 'debt' };
                
                document.getElementById('debt-player-name').innerText = `Agregando a: ${player.name || 'Jugador ' + (playerIndex + 1)}`;
                document.getElementById('debt-amount').value = '';
                
                document.getElementById('debt-modal').classList.remove('hidden');
                setTimeout(() => document.getElementById('debt-amount').focus(), 100);
            },

            closeDebtModal: () => {
                document.getElementById('debt-modal').classList.add('hidden');
                state.tempAction = null;
            },

            confirmDebt: async () => {
                if (!state.tempAction || state.tempAction.type !== 'debt') return;
                
                const amountInput = document.getElementById('debt-amount');
                const amount = parseInt(amountInput.value);
                
                if (isNaN(amount) || amount <= 0) {
                    alert("Por favor ingrese un monto válido mayor a 0.");
                    amountInput.focus();
                    return;
                }

                const { tableId, playerIndex } = state.tempAction;
                const table = state.tables.find(t => t.id === tableId);
                if (table) {
                    const newPlayers = [...table.players];
                    newPlayers[playerIndex].debt = (newPlayers[playerIndex].debt || 0) + amount;
                    
                    App.closeDebtModal();
                    
                    try {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tables', tableId), { players: newPlayers });
                    } catch (err) {
                        console.error("Error updating debt:", err);
                    }
                }
            },

            openPayModal: (tableId, playerIndex) => {
                const table = state.tables.find(t => t.id === tableId);
                if (!table) return;
                const player = table.players[playerIndex];
                const debt = player.debt || 0;

                if (debt <= 0) return;

                state.tempAction = { tableId, playerIndex, type: 'pay' };
                
                document.getElementById('pay-total-debt').innerText = `$${debt}`;
                document.getElementById('pay-player-name').innerText = `Pagando: ${player.name || 'Jugador'}`;
                
                const input = document.getElementById('pay-amount');
                input.value = debt;
                
                document.getElementById('pay-modal').classList.remove('hidden');
                setTimeout(() => {
                    input.focus(); 
                    input.select(); 
                }, 100);
            },

            closePayModal: () => {
                document.getElementById('pay-modal').classList.add('hidden');
                state.tempAction = null;
            },

            confirmPay: async () => {
                if (!state.tempAction || state.tempAction.type !== 'pay') return;
                
                const { tableId, playerIndex } = state.tempAction;
                const table = state.tables.find(t => t.id === tableId);
                
                if (!table) return;

                const input = document.getElementById('pay-amount');
                const paymentAmount = parseInt(input.value);
                const currentDebt = table.players[playerIndex].debt || 0;

                if (isNaN(paymentAmount) || paymentAmount <= 0) {
                    alert("Ingrese un monto válido.");
                    return;
                }

                if (paymentAmount > currentDebt) {
                    alert(`El pago ($${paymentAmount}) no puede ser mayor a la deuda ($${currentDebt}).`);
                    return;
                }

                const newPlayers = [...table.players];
                newPlayers[playerIndex].paid = (newPlayers[playerIndex].paid || 0) + paymentAmount;
                newPlayers[playerIndex].debt = currentDebt - paymentAmount;
                
                App.closePayModal();
                
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tables', tableId), { players: newPlayers });
                } catch (err) {
                    console.error("Error updating payment:", err);
                }
            },

            openCloseModal: (tableId) => {
                const table = state.tables.find(t => t.id === tableId);
                if (!table) return;

                const pendingDebt = table.players.reduce((acc, p) => acc + (p.debt || 0), 0);
                
                if (pendingDebt > 0) {
                    alert(`⛔ ALTO AHÍ ⛔\n\nHay deudas pendientes por $${pendingDebt}.\n\nCobra todo antes de cerrar la mesa.`);
                    return;
                }

                state.tempAction = { tableId, type: 'close' };
                document.getElementById('close-modal').classList.remove('hidden');
            },

            closeCloseModal: () => {
                document.getElementById('close-modal').classList.add('hidden');
                state.tempAction = null;
            },

            confirmCloseTable: async () => {
                if (!state.tempAction || state.tempAction.type !== 'close') return;
                
                const { tableId } = state.tempAction;
                const table = state.tables.find(t => t.id === tableId);
                
                if (table) {
                    const totalPaid = table.players.reduce((acc, p) => acc + (p.paid || 0), 0);
                    
                    App.closeCloseModal();

                    try {
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'history'), {
                            ...table,
                            completedAt: new Date().toLocaleTimeString(),
                            date: new Date().toLocaleDateString(),
                            closedAtTimestamp: Date.now(),
                            totalPaid
                        });
                        
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tables', tableId), {
                            status: 'available',
                            players: Array(4).fill(null).map((_, i) => ({ id: `reset_${i}`, name: "", debt: 0, paid: 0 })),
                            startTime: null
                        });
                    } catch (err) {
                        console.error("Error closing table:", err);
                    }
                }
            },

            // --- GESTIÓN ELIMINAR ---
            openDeleteModal: (tableId) => {
                state.tempAction = { tableId, type: 'delete' };
                document.getElementById('delete-modal').classList.remove('hidden');
            },

            closeDeleteModal: () => {
                document.getElementById('delete-modal').classList.add('hidden');
                state.tempAction = null;
            },

            confirmDeleteTable: async () => {
                if (!state.tempAction || state.tempAction.type !== 'delete') return;
                const { tableId } = state.tempAction;
                
                App.closeDeleteModal();
                
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tables', tableId));
                } catch (e) { console.error("Error deleting table:", e); }
            },

            addTable: async () => {
                if (!state.user) return;
                const input = document.getElementById('new-table-name');
                const name = input.value.trim() || `Mesa ${state.tables.length + 1}`;
                
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'tables'), {
                        name: name,
                        status: 'available',
                        players: Array(4).fill(null).map((_, i) => ({ id: `new_${i}`, name: "", debt: 0, paid: 0 })),
                        startTime: null,
                        createdAt: Date.now()
                    });
                    input.value = '';
                } catch (e) { console.error(e); }
            },

            updatePlayerName: async (tableId, playerIndex, newName) => {
                const table = state.tables.find(t => t.id === tableId);
                if (!table) return;

                const newPlayers = [...table.players];
                newPlayers[playerIndex].name = newName;
                
                let updates = { players: newPlayers };
                if (newName !== "" && table.status === 'available') {
                    updates.status = 'playing';
                    updates.startTime = new Date().toLocaleTimeString();
                }

                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tables', tableId), updates);
            },
        };

        window.app = App;

        // AUTHENTICATION LOGIC
        const initAuth = async () => {
            // En un entorno standalone, intentamos entrar anónimamente directamente
            // Si el usuario necesita auth más robusta (email/pass) habría que implementarlo aquí
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Error signing in anonymously:", error);
                // Si falla el auth, la app mostrará "Desconectado"
            }
        };
        initAuth();

        onAuthStateChanged(auth, (user) => {
            state.user = user;
            const statusEl = document.getElementById('connection-status');
            const statusText = document.getElementById('connection-text');
            
            if (user) {
                statusEl.classList.replace('bg-red-600', 'bg-green-500');
                statusEl.classList.add('shadow-[0_0_10px_rgba(34,197,94,0.5)]');
                statusText.innerText = "EN LÍNEA";
                statusText.classList.replace('text-stone-500', 'text-green-500');
                initDataListeners();
            } else {
                statusEl.classList.replace('bg-green-500', 'bg-red-600');
                statusEl.classList.remove('shadow-[0_0_10px_rgba(34,197,94,0.5)]');
                statusText.innerText = "DESCONECTADO";
                statusText.classList.replace('text-green-500', 'text-stone-500');
            }
        });

        function initDataListeners() {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'tables'), (snapshot) => {
                state.tables = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                    .sort((a, b) => a.createdAt - b.createdAt);
                renderUI();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'history'), (snapshot) => {
                state.history = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                    .sort((a, b) => b.closedAtTimestamp - a.closedAtTimestamp);
                renderUI();
            });
        }

        function renderUI() {
            const { isAdmin, showHistory, tables, history } = state;
            
            document.getElementById('admin-controls').classList.toggle('hidden', !isAdmin);
            document.getElementById('btn-login').classList.toggle('hidden', isAdmin);
            document.getElementById('action-bar').classList.toggle('hidden', !isAdmin || showHistory);
            document.getElementById('dashboard-stats').classList.toggle('hidden', !isAdmin);
            document.getElementById('history-view').classList.toggle('hidden', !showHistory);
            document.getElementById('tables-grid').classList.toggle('hidden', showHistory);
            document.getElementById('empty-state').classList.toggle('hidden', showHistory || tables.length > 0);

            if (isAdmin) renderStats();
            if (!showHistory) renderTables();
            if (showHistory) renderHistory();

            lucide.createIcons();
        }

        function renderStats() {
            const today = new Date().toLocaleDateString();
            let totalDebt = 0;
            let totalCollected = 0;
            let activeCount = 0;
            let loser = { name: 'Nadie', amount: 0 };

            state.tables.forEach(t => {
                if (t.status === 'playing') activeCount++;
                t.players.forEach(p => {
                    totalDebt += (p.debt || 0);
                    totalCollected += (p.paid || 0);
                    if ((p.debt || 0) > loser.amount) loser = { name: p.name, amount: p.debt };
                });
            });

            state.history.forEach(h => {
                if (h.date === today) totalCollected += (h.totalPaid || 0);
            });

            const statsHTML = `
                ${createStatCard('coins', 'Caja Hoy', `$${totalCollected}`, 'amber')}
                ${createStatCard('alert-triangle', 'En la Calle', `$${totalDebt}`, 'red')}
                ${createStatCard('users', 'Mesas Activas', activeCount, 'blue')}
                ${createStatCard('trending-down', 'El Barbarazo', loser.amount > 0 ? `$${loser.amount}` : '-', 'orange', loser.name)}
            `;
            document.getElementById('dashboard-stats').innerHTML = statsHTML;
        }

        function createStatCard(icon, label, value, color, subtext = '') {
            return `
            <div class="bg-stone-900 p-5 rounded-xl border border-stone-800 relative overflow-hidden group hover:border-amber-900/50 transition-colors shadow-lg">
                <div class="absolute -right-4 -top-4 p-3 opacity-5 text-${color}-500 group-hover:opacity-10 transition-opacity">
                    <i data-lucide="${icon}" width="80" height="80"></i>
                </div>
                <div class="flex items-center gap-3 mb-3">
                    <div class="p-2 rounded-lg bg-${color}-500/10 text-${color}-500 border border-${color}-500/20">
                        <i data-lucide="${icon}" class="w-5 h-5"></i>
                    </div>
                    <span class="text-stone-400 text-sm font-medium uppercase tracking-wider">${label}</span>
                </div>
                <div class="text-3xl font-bold text-white mb-1 brand-font tracking-wide">${value}</div>
                ${subtext ? `<div class="text-xs text-amber-500/70 font-medium">${subtext}</div>` : ''}
            </div>`;
        }

        function renderTables() {
            const container = document.getElementById('tables-grid');
            container.innerHTML = state.tables.map(table => {
                const isPlaying = table.status === 'playing';
                const totalDebt = table.players.reduce((acc, p) => acc + (p.debt || 0), 0);
                const playerCount = table.players.filter(p => p.name).length;

                return `
                <div class="rounded-xl transition-all duration-300 ${isPlaying 
                    ? 'bg-stone-900 border-2 border-amber-600/50 shadow-[0_0_20px_rgba(217,119,6,0.1)]' 
                    : 'bg-stone-900/60 border border-stone-800 border-dashed'}">
                    
                    <div class="p-4 border-b border-stone-800 flex justify-between items-start bg-stone-950/30 rounded-t-xl">
                        <div>
                            <h3 class="font-bold text-lg flex items-center gap-2 ${isPlaying ? 'text-white' : 'text-stone-500'} brand-font tracking-wide">
                                ${table.name}
                                <span class="text-[10px] px-2 py-0.5 rounded-sm border font-sans font-bold tracking-wider ${isPlaying ? 'bg-amber-500/20 border-amber-500/30 text-amber-500' : 'bg-stone-800 border-stone-700 text-stone-500'}">
                                    ${isPlaying ? 'OCUPADA' : 'LIBRE'}
                                </span>
                            </h3>
                            <div class="text-xs text-stone-500 mt-1 flex items-center gap-2 font-mono">
                                <i data-lucide="users" class="w-3 h-3"></i> ${playerCount}/4
                            </div>
                        </div>
                        ${state.isAdmin ? `
                        <div class="flex gap-1">
                            ${isPlaying ? `<button onclick="window.app.openCloseModal('${table.id}')" title="Cerrar Mesa" class="p-2 text-stone-400 hover:text-amber-500 hover:bg-amber-500/10 rounded-lg transition-colors"><i data-lucide="save" class="w-5 h-5"></i></button>` : ''}
                            <button onclick="window.app.openDeleteModal('${table.id}')" title="Desmantelar" class="p-2 text-stone-600 hover:text-red-500 hover:bg-red-500/10 rounded-lg transition-colors"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                        </div>
                        ` : ''}
                    </div>

                    <div class="p-4 space-y-3">
                        ${table.players.map((p, idx) => renderPlayerRow(table.id, idx, p, state.isAdmin)).join('')}
                    </div>

                    <div class="px-4 py-4 bg-stone-950/50 border-t border-stone-800 rounded-b-xl flex justify-between items-center">
                        <span class="text-xs text-stone-500 uppercase font-bold tracking-wider">Deuda Mesa</span>
                        <span class="font-mono font-bold text-lg ${totalDebt > 0 ? 'text-red-500' : 'text-stone-600'}">$${totalDebt}</span>
                    </div>
                </div>
                `;
            }).join('');
        }

        function renderPlayerRow(tableId, idx, p, isAdmin) {
            const hasName = p.name && p.name !== "";
            const debt = p.debt || 0;
            
            return `
            <div class="flex items-center justify-between bg-stone-950/40 p-2 rounded-lg border border-stone-800/50 hover:border-stone-700 transition-colors group">
                <div class="flex items-center gap-3 flex-1 overflow-hidden">
                    <div class="w-8 h-8 rounded flex items-center justify-center flex-shrink-0 ${hasName ? 'bg-stone-800 text-amber-600 border border-amber-900/30' : 'bg-stone-900 text-stone-700 border border-stone-800'}">
                        <i data-lucide="user" class="w-4 h-4"></i>
                    </div>
                    ${isAdmin ? 
                        `<input class="bg-transparent text-sm text-stone-200 placeholder-stone-700 focus:outline-none w-full font-medium"
                           placeholder="Jugador ${idx + 1}" value="${p.name}" 
                           onchange="window.app.updatePlayerName('${tableId}', ${idx}, this.value)">` 
                        : 
                        `<span class="text-sm truncate font-medium ${hasName ? 'text-stone-300' : 'text-stone-700 italic'}">${p.name || "Vacío"}</span>`
                    }
                </div>
                
                ${hasName ? `
                <div class="flex items-center gap-3 pl-2">
                    <div class="text-right flex-shrink-0">
                        <div class="text-sm font-mono font-bold ${debt > 0 ? 'text-red-500' : 'text-stone-600'}">$${debt}</div>
                        ${isAdmin ? `<div class="text-[10px] text-stone-600">Pagado: $${p.paid || 0}</div>` : ''}
                    </div>
                    ${isAdmin ? `
                    <div class="flex gap-1 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                        <button onclick="window.app.openDebtModal('${tableId}', ${idx})" title="Añadir deuda" class="p-1.5 text-stone-500 hover:text-red-500 hover:bg-stone-800 rounded transition-colors">
                            <i data-lucide="trending-up" class="w-4 h-4"></i>
                        </button>
                        ${debt > 0 ? `
                        <button onclick="window.app.openPayModal('${tableId}', ${idx})" title="Pagar" class="p-1.5 text-stone-500 hover:text-amber-500 hover:bg-stone-800 rounded transition-colors">
                            <i data-lucide="coins" class="w-4 h-4"></i>
                        </button>` : ''}
                    </div>
                    ` : ''}
                </div>
                ` : ''}
            </div>
            `;
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            if (state.history.length === 0) {
                list.innerHTML = `<tr><td colspan="4" class="px-6 py-12 text-center text-stone-600 font-medium">No hay registros en el libro aún</td></tr>`;
                return;
            }
            list.innerHTML = state.history.map(h => `
                <tr class="border-b border-stone-800 hover:bg-stone-800/30 transition-colors">
                    <td class="px-6 py-4 font-bold text-white brand-font">${h.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-xs text-stone-500 font-mono">${h.date}<br>${h.completedAt}</td>
                    <td class="px-6 py-4 max-w-xs truncate text-stone-400 text-sm">
                        ${h.players ? h.players.filter(p => p.name).map(p => p.name).join(", ") : "Sin datos"}
                    </td>
                    <td class="px-6 py-4 text-right text-amber-500 font-mono font-bold text-lg">$${h.totalPaid || 0}</td>
                </tr>
            `).join('');
        }

    </script>
</body>
</html>
